<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SycoLibre Status Test</title>
    
    <!-- React and Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.1/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #666;
            margin-top: 0;
        }
        
        #status-app {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .api-url-form {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .api-url-form input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>SycoLibre Status Test</h1>
        <p>Test changing user statuses with the PostgreSQL database</p>
    </div>
    
    <div id="status-app">
        <div class="api-url-form">
            <label for="api-base-url">API Base URL:</label>
            <input 
                type="text" 
                id="api-base-url" 
                value="http://localhost:8000" 
                placeholder="http://localhost:8000"
            >
        </div>
        
        <!-- React app will render here -->
        <div id="status-dropdown-container"></div>
    </div>
    
    <script type="text/babel">
        // UserStatusDropdown component
        const UserStatusDropdown = () => {
            const [status, setStatus] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [apiBaseUrl, setApiBaseUrl] = useState('http://localhost:8000');
            
            // Listen for changes to the API base URL input
            useEffect(() => {
                const urlInput = document.getElementById('api-base-url');
                const updateApiUrl = () => setApiBaseUrl(urlInput.value);
                
                urlInput.addEventListener('change', updateApiUrl);
                return () => urlInput.removeEventListener('change', updateApiUrl);
            }, []);
            
            // Fetch the current status when component mounts or API URL changes
            useEffect(() => {
                const fetchCurrentStatus = async () => {
                    try {
                        setIsLoading(true);
                        const response = await axios.get(`${apiBaseUrl}/api/users/1/status`);
                        setStatus(response.data.status);
                        setIsLoading(false);
                    } catch (error) {
                        console.error('Error fetching user status:', error);
                        setMessage('Failed to fetch current status');
                        setIsLoading(false);
                    }
                };
                
                if (apiBaseUrl) {
                    fetchCurrentStatus();
                }
            }, [apiBaseUrl]);
            
            const handleStatusChange = async (e) => {
                const newStatus = e.target.value;
                setStatus(newStatus);
                
                try {
                    setIsLoading(true);
                    setMessage('');
                    
                    await axios.put(`${apiBaseUrl}/api/users/1/status`, { 
                        status: newStatus,
                        last_status_change: new Date().toISOString()
                    });
                    
                    setMessage(`Status updated to ${newStatus}`);
                    setIsLoading(false);
                } catch (error) {
                    console.error('Error updating status:', error);
                    setMessage('Failed to update status: ' + (error.response?.data?.detail || error.message));
                    setIsLoading(false);
                }
            };
            
            // Styles
            const styles = {
                container: {
                    fontFamily: 'Arial, sans-serif',
                    padding: '20px',
                    borderRadius: '8px',
                    boxShadow: '0 2px 10px rgba(0, 0, 0, 0.1)',
                    backgroundColor: '#ffffff'
                },
                dropdownContainer: {
                    marginBottom: '15px',
                    display: 'flex',
                    alignItems: 'center'
                },
                label: {
                    marginRight: '10px',
                    fontWeight: 'bold'
                },
                select: {
                    padding: '8px 12px',
                    borderRadius: '4px',
                    border: '1px solid #ddd',
                    fontSize: '14px',
                    flex: 1
                },
                loading: {
                    marginLeft: '10px',
                    fontSize: '14px',
                    color: '#666'
                },
                message: {
                    padding: '10px',
                    borderRadius: '4px',
                    marginBottom: '15px',
                    fontSize: '14px'
                },
                successMessage: {
                    backgroundColor: '#E8F5E9',
                    color: '#2E7D32'
                },
                errorMessage: {
                    backgroundColor: '#FFEBEE',
                    color: '#C62828'
                },
                statusIndicator: {
                    display: 'flex',
                    alignItems: 'center',
                    marginTop: '15px'
                },
                indicator: {
                    width: '12px',
                    height: '12px',
                    borderRadius: '50%',
                    marginRight: '8px'
                }
            };
            
            return (
                <div style={styles.container}>
                    <h2>User Status Updater (User ID: 1)</h2>
                    
                    <div style={styles.dropdownContainer}>
                        <label htmlFor="status-select" style={styles.label}>
                            Status:
                        </label>
                        <select
                            id="status-select"
                            value={status}
                            onChange={handleStatusChange}
                            disabled={isLoading}
                            style={styles.select}
                        >
                            <option value="" disabled>Select status...</option>
                            <option value="online">Online</option>
                            <option value="away">Away</option>
                            <option value="offline">Offline</option>
                        </select>
                        
                        {isLoading && <span style={styles.loading}>Updating...</span>}
                    </div>
                    
                    {message && (
                        <div style={
                            message.includes('Failed') 
                                ? {...styles.message, ...styles.errorMessage}
                                : {...styles.message, ...styles.successMessage}
                        }>
                            {message}
                        </div>
                    )}
                    
                    <div style={styles.statusIndicator}>
                        <div style={{
                            ...styles.indicator,
                            backgroundColor: 
                                status === 'online' ? '#4CAF50' : 
                                status === 'away' ? '#FFC107' : 
                                status === 'offline' ? '#9E9E9E' : '#CCCCCC'
                        }}></div>
                        <span>Current Status: {status || 'Loading...'}</span>
                    </div>
                    
                    <div style={{marginTop: '20px', fontSize: '14px', color: '#666'}}>
                        <p>API Endpoint: {apiBaseUrl}/api/users/1/status</p>
                    </div>
                </div>
            );
        };
        
        // Render the component
        const { useState, useEffect } = React;
        ReactDOM.render(
            <UserStatusDropdown />,
            document.getElementById('status-dropdown-container')
        );
    </script>
</body>
</html>